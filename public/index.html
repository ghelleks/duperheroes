<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuperHeroes - Animal Superhero Game</title>
    <meta name="description" content="Test your knowledge of satirical animal-themed superheroes in this fun identification game!">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="shared.css">
    <script src="js/advanced-lazy-loading.js"></script>
    <script src="battlecard.js"></script>
    <style>
        /* Game-specific styles only */
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        // Game State Management
        class GameState {
            constructor() {
                this.heroes = [];
                this.currentPage = 'home';
                this.gameState = 'menu';
                this.currentHero = null;
                this.currentHeroImage = '';
                this.choices = [];
                this.correctAnswer = '';
                this.selectedAnswer = '';
                this.showFeedback = false;
                this.loadError = null;
                this.timerPaused = false;
                this.stats = {
                    score: 0,
                    timeRemaining: 60,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentStreak: 0
                };
                this.gameTimer = null;
                this.loadHeroes();
            }

            async loadHeroes() {
                try {
                    const response = await fetch('./heroes.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    if (!data || !data.heroes || !Array.isArray(data.heroes) || data.heroes.length === 0) {
                        throw new Error('Invalid heroes data: missing or empty heroes array');
                    }
                    // Only include heroes that have defined image paths
                    this.heroes = data.heroes.filter(hero => hero.imagePath && hero.imagePath !== null);
                    console.log(`Loaded ${this.heroes.length} heroes with images (filtered from ${data.heroes.length} total heroes)`);
                } catch (error) {
                    console.error('Error loading heroes:', error);
                    this.gameState = 'error';
                    this.loadError = error;
                }
                this.render();
            }



            getHeroImage(hero) {
                return this.createResponsiveHeroImage(hero, 'medium');
            }

            getAnimalEmoji(animalTheme) {
                const emojiMap = {
                    'Dog': 'ğŸ•', 'Poodle': 'ğŸ©', 'Frog': 'ğŸ¸', 'Koala': 'ğŸ¨',
                    'Cat': 'ğŸ±', 'Monkey': 'ğŸ’', 'Bat': 'ğŸ¦‡', 'Eagle': 'ğŸ¦…',
                    'Horse': 'ğŸ´', 'Whale': 'ğŸ‹', 'Fish': 'ğŸŸ', 'Gecko': 'ğŸ¦',
                    'Canary': 'ğŸ¦', 'Panther': 'ğŸ¾', 'Anteater': 'ğŸœ', 'Bee': 'ğŸ',
                    'Octopus': 'ğŸ™', 'Dolphin': 'ğŸ¬', 'Tiger': 'ğŸ…', 'Rhino Beetle': 'ğŸª²',
                    'Lizard': 'ğŸ¦', 'Snake': 'ğŸ', 'Raccoon': 'ğŸ¦', 'Shark': 'ğŸ¦ˆ',
                    'Deer': 'ğŸ¦Œ', 'Gorilla': 'ğŸ¦', 'Cricket': 'ğŸ¦—', 'Kangaroo': 'ğŸ¦˜',
                    'Porcupine': 'ğŸ¦”', 'Albatross': 'ğŸ•Šï¸', 'Ram': 'ğŸ', 'Dove': 'ğŸ•Šï¸',
                    'Buffalo': 'ğŸ‚', 'Skunk': 'ğŸ¦¨', 'Peacock': 'ğŸ¦š', 'Magpie': 'ğŸ¦â€â¬›',
                    'Owl': 'ğŸ¦‰', 'Chameleon': 'ğŸ¦', 'Rhino': 'ğŸ¦', 'Polar Bear': 'ğŸ»â€â„ï¸',
                    'Salamander': 'ğŸ¦', 'Turtle': 'ğŸ¢', 'Hawk': 'ğŸ¦…', 'Spider': 'ğŸ•·ï¸',
                    'Badger': 'ğŸ¦¡', 'Sloth': 'ğŸ¦¥'
                };
                return emojiMap[animalTheme] || 'ğŸ¦¸â€â™‚ï¸';
            }

            // Generate hero slug for file names
            getHeroSlug(heroName) {
                return heroName
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters except hyphens
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .replace(/-+/g, '-') // Replace multiple hyphens with single
                    .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
            }

            // Get size configuration
            getSizeConfig(size) {
                const configs = {
                    thumbnail: { width: 120, height: 120 },
                    medium: { width: 300, height: 300 },
                    large: { width: 600, height: 600 }
                };
                return configs[size] || configs.thumbnail;
            }

            // Create responsive hero image with progressive loading
            createResponsiveHeroImage(hero, size = 'medium') {
                const slug = this.getHeroSlug(hero.superhero_name);
                const emoji = this.getAnimalEmoji(hero.animal_theme);
                const sizeConfig = this.getSizeConfig(size);
                const basePath = `./images/${size}/${slug}`;
                
                return `
                    <div class="progressive-image hero-image-container hero-${size}">
                        <!-- Placeholder with gradient -->
                        <div class="placeholder"></div>
                        
                        <!-- Actual responsive image -->
                        <picture>
                            <source data-srcset="${basePath}.webp" type="image/webp">
                            <img data-src="${basePath}.jpg" 
                                 alt="${hero.superhero_name}" 
                                 class="actual hero-image max-w-full max-h-full object-contain rounded-lg shadow-lg"
                                 width="${sizeConfig.width}" 
                                 height="${sizeConfig.height}">
                        </picture>
                        
                        <!-- Emoji fallback -->
                        <div class="emoji-fallback">
                            <span class="emoji">${emoji}</span>
                        </div>
                    </div>
                `;
            }

            getRandomHero() {
                if (!this.heroes || this.heroes.length === 0) return null;
                return this.heroes[Math.floor(Math.random() * this.heroes.length)];
            }

            generateChoices(correctHero) {
                if (!this.heroes || this.heroes.length < 4) return [];
                
                const wrongChoices = this.heroes
                    .filter(h => h.superhero_name !== correctHero.superhero_name)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3)
                    .map(h => h.superhero_name);

                const allChoices = [correctHero.superhero_name, ...wrongChoices]
                    .sort(() => Math.random() - 0.5);

                return allChoices;
            }

            startGame() {
                if (!this.heroes || this.heroes.length === 0) {
                    console.error('Cannot start game: No heroes loaded');
                    return;
                }
                
                this.gameState = 'playing';
                this.stats = {
                    score: 0,
                    timeRemaining: 60,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentStreak: 0
                };
                this.startTimer();
                this.nextQuestion();
            }

            startTimer() {
                this.gameTimer = setInterval(() => {
                    if (!this.timerPaused) {
                        this.stats.timeRemaining--;
                        if (this.stats.timeRemaining <= 0) {
                            this.endGame();
                        }
                        this.updateTimer();
                    }
                }, 1000);
            }

            updateTimer() {
                const timerElement = document.querySelector('.game-timer');
                if (timerElement) {
                    timerElement.textContent = `â° ${this.stats.timeRemaining}s`;
                }
            }

            async nextQuestion() {
                const hero = this.getRandomHero();
                if (!hero) return;

                this.currentHero = hero;
                this.currentHeroImage = this.getHeroImage(hero);
                this.choices = this.generateChoices(hero);
                this.correctAnswer = hero.superhero_name;
                this.selectedAnswer = '';
                this.showFeedback = false;
                this.render();
            }

            selectAnswer(answer) {
                if (this.showFeedback) return;

                this.selectedAnswer = answer;
                this.showFeedback = true;

                const isCorrect = answer === this.correctAnswer;
                const points = isCorrect ? (10 + this.stats.currentStreak * 2) : 0;

                this.stats.score += points;
                this.stats.questionsAnswered++;
                if (isCorrect) {
                    this.stats.correctAnswers++;
                    this.stats.currentStreak++;
                } else {
                    this.stats.currentStreak = 0;
                }

                // Show feedback battlecard using shared manager
                const streakBonus = isCorrect && this.stats.currentStreak > 1 ? this.stats.currentStreak - 1 : 0;
                
                battlecardManager.showFeedbackBattlecard(
                    this.currentHero, 
                    isCorrect, 
                    streakBonus,
                    () => {
                        // Callback when battlecard closes - resume timer and continue game
                        this.timerPaused = false;
                        if (this.stats.timeRemaining > 0) {
                            this.nextQuestion();
                        }
                    },
                    () => {
                        // Callback when battlecard shows - pause timer
                        this.timerPaused = true;
                    }
                );
            }

            showHeroBattlecard(hero) {
                battlecardManager.showHeroBattlecard(
                    hero,
                    () => {
                        // Callback when battlecard closes - resume timer if in game
                        if (this.gameState === 'playing') {
                            this.timerPaused = false;
                        }
                    },
                    () => {
                        // Callback when battlecard shows - pause timer if in game
                        if (this.gameState === 'playing') {
                            this.timerPaused = true;
                        }
                    }
                );
            }

            endGame() {
                clearInterval(this.gameTimer);
                this.gameState = 'finished';
                this.saveGameStats();
                this.render();
            }

            saveGameStats() {
                try {
                    const localStats = JSON.parse(localStorage.getItem('heroGameStats') || '{}');
                    const personalBest = localStats.beatTheClockBest || 0;

                    if (this.stats.score > personalBest) {
                        localStorage.setItem('heroGameStats', JSON.stringify({
                            ...localStats,
                            beatTheClockBest: this.stats.score,
                            lastPlayed: new Date().toISOString(),
                        }));
                    }
                } catch (error) {
                    console.error('Error saving game stats:', error);
                }
            }

            getPersonalBest() {
                try {
                    const localStats = JSON.parse(localStorage.getItem('heroGameStats') || '{}');
                    return localStats.beatTheClockBest || 0;
                } catch {
                    return 0;
                }
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.gameState === 'error') {
                    app.innerHTML = this.renderError();
                } else if (this.gameState === 'menu') {
                    app.innerHTML = this.renderMenu();
                } else if (this.gameState === 'playing') {
                    app.innerHTML = this.renderGame();
                } else if (this.gameState === 'finished') {
                    app.innerHTML = this.renderResults();
                }
                
                this.attachEventListeners();
            }

            renderMenu() {
                const heroesLoaded = this.heroes && this.heroes.length > 0;
                const heroCount = heroesLoaded ? this.heroes.length : 0;
                
                return `
                    <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div class="text-center text-white max-w-md mx-auto px-4">
                            <h1 class="text-6xl font-bold mb-4">ğŸ¦¸â€â™‚ï¸</h1>
                            <h2 class="text-4xl font-bold mb-4">DuperHeroes</h2>
                            <p class="text-xl mb-6">Animal Superhero Identification Game</p>
                            <p class="text-lg mb-8">Beat the Clock: Identify as many animal superheroes as possible in 60 seconds!</p>
                            <div class="mb-6 text-lg">
                                <p>Personal Best: <span class="font-bold">${this.getPersonalBest()}</span> points</p>
                            </div>
                            <button 
                                onclick="game.startGame()" 
                                class="bg-yellow-400 text-black px-8 py-3 rounded-lg text-xl font-semibold transition-colors ${heroesLoaded ? 'hover:bg-yellow-300' : 'opacity-50 cursor-not-allowed'}"
                                ${!heroesLoaded ? 'disabled' : ''}
                            >
                                ${heroesLoaded ? 'Start Game' : 'Loading Heroes...'}
                            </button>
                            <div class="mt-6">
                                <a href="battlecards.html" class="inline-block bg-white bg-opacity-20 text-white px-6 py-2 rounded-lg font-semibold transition-colors hover:bg-opacity-30 backdrop-blur-sm">
                                    ğŸ“š View Battle Cards Collection
                                </a>
                            </div>
                            <div class="mt-8 text-sm opacity-80">
                                <p>Test your knowledge of satirical animal-themed superheroes!</p>
                                <p class="mt-2">${heroCount > 0 ? `${heroCount} heroes loaded` : 'Loading hero data...'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderGame() {
                if (!this.currentHero) return '';

                return `
                    <div class="min-h-screen bg-gradient-to-br from-purple-500 to-pink-600">
                        <!-- Game Header -->
                        <div class="game-stats p-4">
                            <div class="max-w-4xl mx-auto flex justify-between items-center text-white">
                                <div class="text-xl font-bold">Score: ${this.stats.score}</div>
                                <div class="text-2xl font-bold game-timer">â° ${this.stats.timeRemaining}s</div>
                                <div class="text-xl">Streak: ${this.stats.currentStreak}</div>
                            </div>
                        </div>

                        <!-- Game Content -->
                        <div class="max-w-2xl mx-auto px-4 py-8">
                            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                                <!-- Hero Image -->
                                <div class="h-64 bg-gray-200 flex items-center justify-center cursor-pointer hover:bg-gray-300 transition-colors" onclick="game.showHeroBattlecard(game.currentHero)" title="Click to view battlecard">
                                    ${this.currentHeroImage}
                                </div>

                                <!-- Question -->
                                <div class="p-6">
                                    <h2 class="text-2xl font-bold text-center mb-6">Who is this superhero?</h2>
                                    
                                    <!-- Answer Choices -->
                                    <div class="grid grid-cols-1 gap-3">
                                        ${this.choices.map((choice, index) => {
                                            let buttonClass = "choice-button w-full p-4 text-left rounded-lg border-2 transition-all duration-200 ";
                                            
                                            if (this.showFeedback) {
                                                if (choice === this.correctAnswer) {
                                                    buttonClass += "correct";
                                                } else if (choice === this.selectedAnswer && choice !== this.correctAnswer) {
                                                    buttonClass += "incorrect";
                                                } else {
                                                    buttonClass += "bg-gray-100 text-gray-600 border-gray-300 disabled";
                                                }
                                            } else {
                                                buttonClass += "bg-gray-50 hover:bg-blue-50 border-gray-300 hover:border-blue-300 cursor-pointer";
                                            }

                                            return `
                                                <button 
                                                    onclick="game.selectAnswer('${choice}')" 
                                                    class="${buttonClass}"
                                                    ${this.showFeedback ? 'disabled' : ''}
                                                >
                                                    <span class="font-semibold">${choice}</span>
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResults() {
                const personalBest = this.getPersonalBest();
                const isNewRecord = this.stats.score > personalBest;

                return `
                    <div class="min-h-screen bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center">
                        <div class="text-center text-white max-w-md mx-auto px-4">
                            <h1 class="text-5xl font-bold mb-4">Time's Up!</h1>
                            ${isNewRecord ? '<div class="text-2xl mb-4 text-yellow-300">ğŸ‰ New Personal Best! ğŸ‰</div>' : ''}
                            <div class="bg-white/20 rounded-lg p-6 mb-6">
                                <div class="text-3xl font-bold mb-2">${this.stats.score} Points</div>
                                <div class="text-lg space-y-1">
                                    <div>Questions: ${this.stats.questionsAnswered}</div>
                                    <div>Correct: ${this.stats.correctAnswers}</div>
                                    <div>Accuracy: ${this.stats.questionsAnswered > 0 ? Math.round((this.stats.correctAnswers / this.stats.questionsAnswered) * 100) : 0}%</div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <button
                                    onclick="game.startGame()"
                                    class="w-full bg-yellow-400 text-black px-6 py-3 rounded-lg text-lg font-semibold hover:bg-yellow-300 transition-colors"
                                >
                                    Play Again
                                </button>
                                <button
                                    onclick="game.gameState = 'menu'; game.render();"
                                    class="w-full bg-white/20 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-white/30 transition-colors"
                                >
                                    Back to Menu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderError() {
                const errorMessage = this.loadError?.message || 'Unknown error occurred';
                const isNetworkError = errorMessage.includes('HTTP') || errorMessage.includes('fetch');
                const isDataError = errorMessage.includes('Invalid heroes data');
                
                return `
                    <div class="min-h-screen bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center">
                        <div class="text-center text-white max-w-lg mx-auto px-4">
                            <div class="text-6xl mb-6">ğŸš¨</div>
                            <h1 class="text-4xl font-bold mb-4">Oops! Game Data Unavailable</h1>
                            <div class="bg-white/20 rounded-lg p-6 mb-6">
                                <h2 class="text-xl font-semibold mb-3">What happened?</h2>
                                <p class="text-lg mb-3">
                                    ${isNetworkError 
                                        ? 'The hero data file could not be loaded from the server.' 
                                        : isDataError 
                                        ? 'The hero data file is corrupted or empty.'
                                        : 'There was an error loading the game data.'}
                                </p>
                                <div class="text-sm bg-red-900/30 rounded-lg p-3 text-left">
                                    <strong>Technical details:</strong><br>
                                    ${errorMessage}
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold">Try these solutions:</h3>
                                <div class="text-left bg-white/10 rounded-lg p-4 space-y-2">
                                    ${isNetworkError ? `
                                        <div>â€¢ Check your internet connection</div>
                                        <div>â€¢ Refresh the page (Ctrl+F5 or Cmd+Shift+R)</div>
                                        <div>â€¢ Try again in a few minutes</div>
                                    ` : `
                                        <div>â€¢ Refresh the page to try loading again</div>
                                        <div>â€¢ Clear your browser cache</div>
                                        <div>â€¢ Contact support if the issue persists</div>
                                    `}
                                </div>
                            </div>
                            
                            <div class="mt-6 space-y-3">
                                <button
                                    onclick="window.location.reload()"
                                    class="w-full bg-yellow-400 text-black px-6 py-3 rounded-lg text-lg font-semibold hover:bg-yellow-300 transition-colors"
                                >
                                    ğŸ”„ Refresh Page
                                </button>
                                <button
                                    onclick="game.loadHeroes()"
                                    class="w-full bg-white/20 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-white/30 transition-colors"
                                >
                                    ğŸ”„ Try Again
                                </button>
                            </div>
                            
                            <div class="mt-8 text-sm opacity-80">
                                <p>DuperHeroes requires hero data to function properly.</p>
                                <p class="mt-2">If this problem persists, please report it to the developers.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachEventListeners() {
                // Event listeners are handled through onclick attributes in the HTML
            }
        }

        // Initialize the game
        window.game = new GameState();
    </script>
</body>
</html>